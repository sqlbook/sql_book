<% if signed_in? %>
  <% if @workspace %>
    <% workspace_nav_section = case controller_path
                               when 'app/workspaces'
                                 action_name == 'show' ? :chat : nil
                               when 'app/workspaces/data_sources', 'app/workspaces/data_sources/set_up'
                                 :data_sources
                               when 'app/workspaces/queries', 'app/workspaces/data_sources/queries'
                                 :queries
                               when 'app/workspaces/dashboards'
                                 :dashboards
                               when 'app/workspaces/settings'
                                 :settings
                               end %>
    <% workspace_navigation_items = [
         {
           key: :chat,
           path: app_workspace_path(@workspace),
           icon: 'ri-message-ai-3-line',
           label: 'Chat',
           aria_label: "Open chat for the #{@workspace.name} workspace"
         },
         {
           key: :data_sources,
           path: app_workspace_data_sources_path(@workspace),
           icon: 'ri-database-2-line',
           label: 'Data Sources',
           aria_label: "View datasources for the #{@workspace.name} workspace"
         },
         {
           key: :queries,
           path: app_workspace_queries_path(@workspace),
           icon: 'ri-book-open-line',
           label: 'Query Library',
           aria_label: "View queries for the #{@workspace.name} workspace"
         },
         {
           key: :dashboards,
           path: app_workspace_dashboards_path(@workspace),
           icon: 'ri-dashboard-line',
           label: 'Dashboards',
           aria_label: "View dashboards for the #{@workspace.name} workspace"
         },
         {
           key: :settings,
           path: app_workspace_settings_path(@workspace),
           icon: 'ri-settings-3-line',
           label: 'Settings',
           aria_label: "View workspace settings for the #{@workspace.name} workspace"
         }
       ] %>
  <% end %>

  <header class="header <%= 'with-workspace' if @workspace %>">
    <% if @workspace %>
      <div class="workspace-header-left">
        <%= link_to app_workspaces_path, "aria-label": "Return to the workspaces page" do %>
          <%= render "shared/logo" %>
        <% end %>

        <div class="select desktop-workspace-switcher" data-controller="menu">
          <%= select_tag :workspace_id, options_from_collection_for_select(@current_user.workspaces, :id, :name, selected: @workspace.id), { "data-action": "change->menu#changeWorkspace" } %>
          <i class="ri-arrow-drop-down-line"></i>
        </div>
      </div>

      <nav class="workspace-desktop-nav" aria-label="Workspace navigation">
        <% workspace_navigation_items.each do |item| %>
          <% active_class = "workspace-desktop-nav-item#{' active' if workspace_nav_section == item[:key]}" %>
          <%= link_to item[:path], class: active_class, "aria-label": item[:aria_label] do %>
            <i class="<%= item[:icon] %>"></i>
            <span><%= item[:label] %></span>
          <% end %>
        <% end %>
      </nav>

      <div class="menu-actions">
        <menu data-controller="menu" class="workspace-menu">
          <button class="link secondary toggle-menu" data-menu-target="button" data-action="menu#toggle" aria-label="Toggle workspace menu">
            <i class="ri-menu-line"></i>
            <i class="ri-close-line"></i>
          </button>

          <div class="dropdown" data-menu-target="dropdown" data-action="keydown.esc->menu#close" tabindex="0">
            <label class="text-small category heading">Workspace</label>
            <div class="select">
              <%= select_tag :workspace_id, options_from_collection_for_select(@current_user.workspaces, :id, :name, selected: @workspace.id), { "data-action": "change->menu#changeWorkspace" } %>
              <i class="ri-arrow-drop-down-line"></i>
            </div>

            <% workspace_navigation_items.each do |item| %>
              <%= link_to item[:path], class: "link secondary menu-item", "aria-label": item[:aria_label] do %>
                <i class="<%= item[:icon] %>"></i> <%= item[:label] %>
              <% end %>
            <% end %>
          </div>
        </menu>

        <menu data-controller="menu" class="account-menu">
          <button class="link secondary toggle-menu" data-menu-target="button" data-action="menu#toggle" aria-label="Toggle account menu">
            <i class="ri-account-circle-line"></i>
            <i class="ri-close-line"></i>
          </button>

          <div class="dropdown" data-menu-target="dropdown" data-action="keydown.esc->menu#close" tabindex="0">
            <label class="text-small category heading">Account</label>
            <%= link_to app_account_settings_path, class: "link secondary menu-item", "aria-label": "View account settings" do %>
              <i class="ri-settings-3-line"></i> Settings
            <% end %>
            <%= link_to auth_signout_index_path, class: "link secondary menu-item", "aria-label": "Log out" do %>
              <i class="ri-logout-box-r-line"></i> Log out
            <% end %>
          </div>
        </menu>
      </div>
    <% else %>
      <%= link_to app_workspaces_path, "aria-label": "Return to the workspaces page" do %>
        <%= render "shared/logo" %>
      <% end %>
    <% end %>
  </header>
<% else %>
  <header class="header split">
    <%= link_to root_path, "aria-label": "Return to the home page" do %>
      <%= render "shared/logo" %>
    <% end %>

    <menu>
      <% if signup_page? %>
        <p>Already have an account? <%= link_to "Log in", auth_login_index_path, class: "link secondary text-large", "aria-label": "Visit the login page" %>
      <% elsif login_page? %>
        <p>New to sqlbook? <%= link_to "[Sign up]", auth_signup_index_path, class: "link primary text-large", "data-shortcut": "S", "aria-label": "Visit the sign up page" %>
      <% else %>
        <%= link_to "[Sign up]", auth_signup_index_path, class: "link primary text-large", "data-shortcut": "S", "aria-label": "Visit the sign up page" %>
        <%= link_to "Log in", auth_login_index_path, class: "link secondary text-large", "aria-label": "Visit the login page" %>
      <% end %>
    </menu>
  </header>
<% end %>
